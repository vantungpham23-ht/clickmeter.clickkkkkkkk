<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickMeter Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Authentication Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 100%);
        }

        .auth-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            color: #000000;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: #333333;
            font-size: 0.9rem;
        }

        .form-input {
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: #ffffff;
        }

        .form-input:focus {
            outline: none;
            border-color: #000000;
        }

        .auth-btn {
            background-color: #000000;
            color: #ffffff;
            border: none;
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            background-color: #333333;
        }

        .auth-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666666;
        }

        .auth-switch a {
            color: #000000;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            background-color: #f5f5f5;
            border: 1px solid #cccccc;
            color: #cc0000;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            text-align: center;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            min-height: 100vh;
            background-color: #ffffff;
        }

        .dashboard-header {
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000000;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            background-color: #000000;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #333333;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #000000;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* KPI Row */
        .kpi-row {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .kpi-card {
            flex: 1;
            min-width: 200px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: box-shadow 0.2s;
        }

        .kpi-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.lifetime {
            background: #000000;
            color: #ffffff;
            border-color: #000000;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: #666666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #000000;
        }

        .kpi-card.lifetime .kpi-label,
        .kpi-card.lifetime .kpi-value {
            color: #ffffff;
        }

        /* Table Styles */
        .table-container {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        .table-header {
            background: #f8f8f8;
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #000000;
        }

        .table-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f8f8f8;
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: #000000;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }

        tr:nth-child(even) {
            background-color: #fafafa;
        }

        tr:nth-child(odd) {
            background-color: #ffffff;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .url-cell {
            max-width: 200px;
            word-break: break-all;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: #333333;
            line-height: 1.4;
        }

        .time-cell {
            white-space: nowrap;
            font-size: 0.85rem;
            color: #666666;
        }

        .id-cell {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: #333333;
            max-width: 80px;
            word-break: break-all;
        }

        /* Custom scrollbar */
        .table-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .table-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .table-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Chart Styles */
        .chart-container {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: #000000;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            margin: 40px 0;
            color: #666666;
            font-size: 1.1rem;
        }

        .error-message {
            background-color: #f5f5f5;
            border: 1px solid #cccccc;
            color: #cc0000;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #000000;
            color: #ffffff;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .auth-card {
                margin: 20px;
                padding: 30px 20px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .kpi-row {
                flex-direction: column;
            }

            .kpi-card {
                min-width: auto;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 10px 12px;
            }

            .url-cell {
                max-width: 150px;
            }

            .id-cell {
                max-width: 60px;
            }

            .table-scroll-container {
                max-height: 300px;
            }

            .main-content {
                padding: 20px 15px;
            }
        }

        @media (max-width: 480px) {
            .auth-title {
                font-size: 1.5rem;
            }

            .dashboard-title {
                font-size: 1.5rem;
            }

            .kpi-value {
                font-size: 1.8rem;
            }

            th, td {
                padding: 8px 10px;
            }

            .url-cell {
                max-width: 120px;
            }

            .id-cell {
                max-width: 50px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container">
        <div class="auth-card">
            <h1 id="auth-title" class="auth-title">ClickMeter</h1>
            <div id="auth-error" class="error-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label class="form-label" for="login-email">Email</label>
                    <input type="email" id="login-email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-input" required>
                </div>
                <button type="submit" class="auth-btn" id="login-btn">Sign In</button>
            </form>

            <div class="auth-info">
                <p style="text-align: center; color: #666666; font-size: 0.9rem; margin-top: 20px;">
                    Contact administrator for account access
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboard-container" class="dashboard-container">
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">ClickMeter Dashboard</h1>
                <div class="header-actions">
                    <button class="btn" onclick="loadClicks()">Refresh Data</button>
                    <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- KPI Row -->
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">Archived Total</div>
                    <div id="kpi-archived" class="kpi-value">—</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Current (Last 20K)</div>
                    <div id="kpi-current" class="kpi-value">—</div>
                </div>
                <div class="kpi-card lifetime">
                    <div class="kpi-label">Lifetime Total</div>
                    <div id="kpi-lifetime" class="kpi-value">—</div>
                </div>
            </div>

            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="loading" class="loading" style="display: none;">Loading click data...</div>

            <!-- Clicks Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Recent Clicks (Latest 5)</h2>
                </div>
                <div class="table-scroll-container">
                    <table id="clicks-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Link ID</th>
                                <th>Target URL</th>
                                <th>Time</th>
                                <th>Referrer</th>
                            </tr>
                        </thead>
                        <tbody id="clicks-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <h2 class="chart-title">Daily Clicks Overview (Last 10 Days)</h2>
                <div class="chart-wrapper">
                    <canvas id="clicksChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast">New click received!</div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://ctkjfyukugxhsehkpflp.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0a2pmeXVrdWd4aHNlaGtwZmxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExOTIyOTcsImV4cCI6MjA3Njc2ODI5N30.reLEulXpuXWiWZEWvjD_VdIggOm597Ejx-EndoqoJ8Q";

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let clicksChart = null;
        let clicksSubscription = null;

        // Authentication Functions
        function showError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        async function signIn(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;
                
                showDashboard();
            } catch (error) {
                showError(error.message);
            }
        }

        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                showAuth();
            } catch (error) {
                showError(error.message);
            }
        }

        function showAuth() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('dashboard-container').style.display = 'none';
            
            // Clean up subscriptions
            if (clicksSubscription) {
                clicksSubscription.unsubscribe();
                clicksSubscription = null;
            }
        }

        function showDashboard() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            
            // Load dashboard data
            loadClicks();
            loadLifetimeKpis();
        }

        // Dashboard Functions
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function showToast(message = 'New click received!') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function addNewClickToTable(click) {
            const tbody = document.getElementById('clicks-tbody');
            const row = tbody.insertRow(0);
            
            const idCell = row.insertCell(0);
            idCell.textContent = click.id;
            idCell.className = 'id-cell';

            const linkIdCell = row.insertCell(1);
            linkIdCell.textContent = click.link_id || '-';
            linkIdCell.className = 'id-cell';

            const urlCell = row.insertCell(2);
            urlCell.textContent = click.target_url || '-';
            urlCell.className = 'url-cell';

            const timeCell = row.insertCell(3);
            timeCell.textContent = click.ts ? formatTime(click.ts) : '-';
            timeCell.className = 'time-cell';

            const referrerCell = row.insertCell(4);
            referrerCell.textContent = click.referrer || '-';
            referrerCell.className = 'url-cell';

            row.style.backgroundColor = '#e8f4fd';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);

            // Keep only 5 most recent clicks
            if (tbody.rows.length > 5) {
                tbody.removeChild(tbody.lastChild);
            }
        }

        function updateChartWithNewClick(click) {
            if (!click.ts || !clicksChart) return;
            
            const date = new Date(click.ts);
            const dateKey = date.toISOString().split('T')[0];
            
            // Check if this date is within the last 10 days
            const last10Days = getLast10Days();
            const dateIndex = last10Days.indexOf(dateKey);
            
            if (dateIndex !== -1) {
                // Date is within the last 10 days, update the chart
                clicksChart.data.datasets[0].data[dateIndex]++;
                clicksChart.update();
            }
        }

        function setupRealtimeSubscription() {
            if (clicksSubscription) {
                clicksSubscription.unsubscribe();
            }

            clicksSubscription = supabase
                .channel('clicks-changes')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'clicks'
                }, (payload) => {
                    console.log('New click received:', payload.new);
                    showToast();
                    addNewClickToTable(payload.new);
                    updateChartWithNewClick(payload.new);
                    loadLifetimeKpis(); // Update KPIs
                })
                .subscribe();
        }

        function groupClicksByDate(clicks) {
            const dailyCounts = {};
            
            clicks.forEach(click => {
                if (click.ts) {
                    const date = new Date(click.ts);
                    const dateKey = date.toISOString().split('T')[0];
                    dailyCounts[dateKey] = (dailyCounts[dateKey] || 0) + 1;
                }
            });
            
            return dailyCounts;
        }

        function getLast10Days() {
            const dates = [];
            const today = new Date();
            
            for (let i = 9; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            return dates;
        }

        function prepareChartData(dailyCounts) {
            const last10Days = getLast10Days();
            const labels = [];
            const data = [];
            
            last10Days.forEach(date => {
                labels.push(date);
                data.push(dailyCounts[date] || 0);
            });
            
            return { labels, data };
        }

        function updateChart(dailyCounts) {
            const ctx = document.getElementById('clicksChart').getContext('2d');
            
            const { labels, data } = prepareChartData(dailyCounts);
            
            // Calculate smart Y-axis max to prevent chart from being too tall
            const maxValue = Math.max(...data);
            let yAxisMax;
            
            if (maxValue <= 10) {
                yAxisMax = 10;
            } else if (maxValue <= 100) {
                yAxisMax = Math.ceil(maxValue / 10) * 10; // Round up to nearest 10
            } else if (maxValue <= 1000) {
                yAxisMax = Math.ceil(maxValue / 50) * 50; // Round up to nearest 50
            } else if (maxValue <= 10000) {
                yAxisMax = Math.ceil(maxValue / 500) * 500; // Round up to nearest 500
            } else {
                yAxisMax = Math.ceil(maxValue / 1000) * 1000; // Round up to nearest 1000
            }
            
            if (clicksChart) {
                clicksChart.destroy();
            }
            
            clicksChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Clicks',
                        data: data,
                        backgroundColor: '#000000',
                        borderColor: '#000000',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Last 10 Days',
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    size: 12,
                                    weight: '500'
                                }
                            },
                            ticks: {
                                color: '#666666',
                                font: {
                                    family: 'Inter',
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: {
                                color: '#f0f0f0'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Total Clicks',
                                color: '#000000',
                                font: {
                                    family: 'Inter',
                                    size: 12,
                                    weight: '500'
                                }
                            },
                            min: 0,
                            max: yAxisMax,
                            ticks: {
                                color: '#666666',
                                font: {
                                    family: 'Inter',
                                    size: 11
                                },
                                beginAtZero: true,
                                callback: function(value) {
                                    // Format large numbers with K, M suffixes
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                color: '#f0f0f0'
                            }
                        }
                    }
                }
            });
        }

        function showDashboardError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideDashboardError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('clicks-table').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('clicks-table').style.display = 'table';
        }

        // Lifetime KPIs function
        async function loadLifetimeKpis() {
            try {
                // Archived total = SUM(total_clicks) from clicks_daily
                const ar = await supabase
                    .from('clicks_daily')
                    .select('total_clicks');
                
                const archived = (ar.data || []).reduce((s, r) => s + (r.total_clicks || 0), 0);

                // Current = COUNT(*) from clicks
                const cr = await supabase
                    .from('clicks')
                    .select('id', { count: 'exact' });
                const current = cr.count || 0;

                const lifetime = archived + current;

                document.getElementById('kpi-archived').textContent = archived.toLocaleString();
                document.getElementById('kpi-current').textContent = current.toLocaleString();
                document.getElementById('kpi-lifetime').textContent = lifetime.toLocaleString();
            } catch (e) {
                console.error('loadLifetimeKpis error', e);
            }
        }

        async function loadClicks() {
            try {
                showLoading();
                hideDashboardError();

                const { data: allData, error: allError } = await supabase
                    .from('clicks')
                    .select('id, link_id, target_url, ts, referrer, user_agent')
                    .order('ts', { ascending: false });

                if (allError) {
                    throw allError;
                }

                const data = allData.slice(0, 5); // Only show 5 most recent clicks

                const dailyCounts = groupClicksByDate(allData);
                updateChart(dailyCounts);

                const tbody = document.getElementById('clicks-tbody');
                tbody.innerHTML = '';

                data.forEach(click => {
                    const row = tbody.insertRow();
                    
                    const idCell = row.insertCell(0);
                    idCell.textContent = click.id;
                    idCell.className = 'id-cell';

                    const linkIdCell = row.insertCell(1);
                    linkIdCell.textContent = click.link_id || '-';
                    linkIdCell.className = 'id-cell';

                    const urlCell = row.insertCell(2);
                    urlCell.textContent = click.target_url || '-';
                    urlCell.className = 'url-cell';

                    const timeCell = row.insertCell(3);
                    timeCell.textContent = click.ts ? formatTime(click.ts) : '-';
                    timeCell.className = 'time-cell';

                    const referrerCell = row.insertCell(4);
                    referrerCell.textContent = click.referrer || '-';
                    referrerCell.className = 'url-cell';
                });

                hideLoading();
                setupRealtimeSubscription();

            } catch (error) {
                console.error('Error loading clicks:', error);
                showDashboardError(`Failed to load click data: ${error.message}`);
                hideLoading();
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    showDashboard();
                } else {
                    showAuth();
                }
            });

            // Auth form event listeners
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await signIn(email, password);
            });

            // Listen for auth state changes
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    showDashboard();
                } else if (event === 'SIGNED_OUT') {
                    showAuth();
                }
            });
        });

        // Clean up subscription when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (clicksSubscription) {
                clicksSubscription.unsubscribe();
            }
        });
    </script>
</body>
</html>